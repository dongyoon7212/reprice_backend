<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.reprice_backend.mapper.ProductMapper">

    <resultMap id="ProductResultMap" type="com.example.reprice_backend.entity.Product">
        <id property="productId" column="product_id" />
        <result property="sellerId" column="seller_id" />
        <result property="title" column="title" />
        <result property="description" column="description" />
        <result property="category" column="category" />
        <result property="price" column="price" />
        <result property="conditionGrade" column="condition_grade" />
        <result property="tradeType" column="tradeType" />
        <result property="status" column="status" />
        <result property="createDt" column="create_dt" />
        <result property="updateDt" column="update_dt" />
    </resultMap>

    <resultMap id="ProductListResultMap" type="com.example.reprice_backend.dto.ProductListDto">
        <id property="productId" column="product_id" />
        <result property="sellerId" column="seller_id" />
        <result property="title" column="title" />
        <result property="description" column="description" />
        <result property="category" column="category" />
        <result property="price" column="price" />
        <result property="conditionGrade" column="condition_grade" />
        <result property="tradeType" column="tradeType" />
        <result property="status" column="status" />
        <result property="createDt" column="create_dt" />
        <result property="updateDt" column="update_dt" />
        <result property="thumbnail" column="thumbnail" />
    </resultMap>

    <insert id="addProduct" useGeneratedKeys="true" keyProperty="productId">
        insert into
            product_tb
        values (
            0,
            #{sellerId},
            #{title},
            #{description},
            #{category},
            #{price},
            #{conditionGrade},
            #{tradeType},
            #{status},
            now(),
            now()
        );
    </insert>

    <select id="getProductList" resultMap="ProductListResultMap">
        select
            pt.product_id,
            pt.title,
            pt.description,
            pt.category,
            pt.price,
            pt.condition_grade,
            pt.trade_type,
            pt.status,
            pt.create_dt,
            pit.image_url
        from
            product_tb pt
        join
            product_image_tb pit on (pit.product_id = pt.product_id)
            and pit.thumbnail = 1
<!--        where-->
<!--            (-->
<!--                #{cursorCreateDt} is null or-->
<!--                pt.create_dt &gt; #{cursorCreateDt} or-->
<!--                (pt.create_dt = #{cursorCreateDt} and pt.product_id &gt; #{cursorProductId})-->
<!--            )-->
        <where>
            <if test="cursorCreateDt != null and cursorProductId != null">
                pt.create_dt <![CDATA[ < ]]> #{cursorCreateDt}
                OR (pt.create_dt = #{cursorCreateDt} AND pt.product_id <![CDATA[ < ]]> #{cursorProductId})
            </if>

            <if test="status != null and status != ''">
                AND pt.status = #{status}
            </if>

            <if test="keyword != null and keyword != ''">
                AND (
                    pt.title LIKE CONCAT('%', #{keyword}, '%')
                    OR pt.description LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
        order by
            pt.create_dt desc,
            pt.product_id desc
        limit #{limit};
    </select>
</mapper>